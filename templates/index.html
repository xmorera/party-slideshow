<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>üéâ SFC 30 Party - Live Slideshow</title>
<meta name="color-scheme" content="light dark">
<style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
        font-family: "Segoe UI", system-ui, sans-serif;
        background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        min-height:100vh;
        overflow:hidden;
        color:#fff;
        -webkit-font-smoothing: antialiased;
    }

    /* Re‚Äëusable glass style */
    .glass {
        background:rgba(255,255,255,0.18);
        backdrop-filter: blur(12px) saturate(140%);
        -webkit-backdrop-filter: blur(12px) saturate(140%);
        border:1px solid rgba(255,255,255,0.25);
        box-shadow:0 4px 18px -4px rgba(0,0,0,0.4);
    }

    a, button { cursor:pointer; }

    .nav-buttons {
        position:fixed; top:20px; right:20px; display:flex; gap:10px; z-index:1000;
    }
    .nav-btn {
        font-size:14px; font-weight:500; padding:12px 18px; border-radius:25px;
        color:#fff; text-decoration:none; transition:.25s;
    }
    .nav-btn:hover { transform:translateY(-2px); background:rgba(255,255,255,.35); }

    .title-overlay {
        position:fixed; top:20px; left:50%; transform:translateX(-50%);
        padding:14px 32px; border-radius:28px; text-align:center; z-index:900;
    }
    .main-title {
        font-size:2.1rem; font-weight:700; line-height:1.1;
        background:linear-gradient(45deg,#FFD700,#FFA500,#FF6B6B);
        -webkit-background-clip:text; background-clip:text; color:transparent;
        margin-bottom:4px;
    }
    .subtitle { font-size:.85rem; font-weight:300; letter-spacing:.5px; }

    /* Loading */
    .loading-overlay {
        position:fixed; inset:0;
        display:flex; flex-direction:column; gap:18px;
        align-items:center; justify-content:center;
        text-align:center; z-index:3000;
        background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    }
    .spinner {
        width:46px; height:46px; border-radius:50%;
        border:4px solid rgba(255,255,255,.35);
        border-top:4px solid #fff; animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg);} }

    /* Carousel layout */
    .carousel-container {
        position:fixed; top:50%; left:0; width:100%; height:50vh;
        transform:translateY(-50%);
        overflow:hidden; padding:20px;
        display:flex; align-items:center;
    }
    .carousel-viewport {
        position:relative; width:100%; height:100%; overflow:hidden;
    }
    .carousel-track {
        display:flex; height:100%; will-change:transform;
        /* transform set via JS */
        gap:20px;
    }
    .carousel-segment { display:flex; gap:20px; height:100%; }
    .carousel-item {
        flex:0 0 300px; height:100%; position:relative; border-radius:16px;
        overflow:hidden; background:#222;
        transition:transform .4s, box-shadow .4s;
    }
    .carousel-item img {
        width:100%; height:100%; object-fit:cover; display:block;
        user-select:none; -webkit-user-drag:none;
    }
    .carousel-item:focus-visible { outline:3px solid #FFD700; }
    .carousel-item:hover {
        transform:scale(1.05);
        box-shadow:0 18px 38px -8px rgba(0,0,0,.55);
        z-index:10;
    }

    /* Controls */
    .speed-controls {
        position:fixed; top:110px; right:20px; display:flex; flex-direction:column; gap:6px; z-index:950;
    }
    .speed-btn {
        font-size:12px; padding:8px 14px; border-radius:18px;
        border:0; color:#fff; letter-spacing:.5px;
        transition:background .25s, transform .25s;
    }
    .speed-btn:hover { background:rgba(255,255,255,.28); }
    .speed-btn.active { background:rgba(255,215,0,.38); box-shadow:0 0 0 1px rgba(255,215,0,.55) inset; }

    .carousel-controls {
        position:fixed; bottom:30px; left:50%; transform:translateX(-50%);
        display:flex; gap:16px; z-index:950;
    }
    .control-btn {
        width:52px; height:52px; border-radius:50%; font-size:20px;
        border:0; display:flex; align-items:center; justify-content:center;
        transition:.25s;
    }
    .control-btn:hover { transform:scale(1.12); background:rgba(255,255,255,.33); }

    .image-counter {
        position:fixed; bottom:30px; right:30px;
        padding:10px 22px; font-size:14px; border-radius:26px; z-index:950;
        letter-spacing:.5px;
    }

    /* Popup */
    .image-popup {
        position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
        background:rgba(0,0,0,.85); backdrop-filter: blur(14px);
        opacity:0; pointer-events:none; transition:opacity .3s;
        z-index:4000;
    }
    .image-popup.open { opacity:1; pointer-events:all; }
    .popup-content { max-width:88vw; max-height:88vh; position:relative; }
    .popup-content img {
        width:100%; max-height:88vh; object-fit:contain; border-radius:12px; display:block;
    }
    .close-popup {
        position:absolute; top:10px; right:10px; width:44px; height:44px;
        border-radius:50%; border:0; font-size:26px; line-height:1;
        background:rgba(0,0,0,.55); color:#fff; cursor:pointer; transition:.25s;
    }
    .close-popup:hover { background:rgba(0,0,0,.75); }

    /* Notification (new images) */
    .toast {
        position:fixed; top:100px; left:50%; transform:translateX(-50%);
        padding:14px 30px; border-radius:26px; font-size:15px;
        animation:fadeSlide 3.2s forwards; z-index:3600;
        background:linear-gradient(135deg,#34d058,#28a745);
        box-shadow:0 8px 24px -6px rgba(0,0,0,.45);
    }
    @keyframes fadeSlide {
        0% { opacity:0; transform:translate(-50%, -10px); }
        10%,80% { opacity:1; transform:translate(-50%, 0); }
        100% { opacity:0; transform:translate(-50%, -6px); }
    }

    .paused .carousel-track { /* visual hint if desired */ }

    /* Mobile */
    @media (max-width:900px) {
        .carousel-item { flex-basis:260px; }
        .title-overlay { padding:12px 24px; }
        .main-title { font-size:1.65rem; }
        .speed-controls { top:90px; }
    }
    @media (max-width:600px) {
        .carousel-container { height:45vh; padding:12px; }
        .carousel-item { flex-basis:220px; }
        .control-btn { width:46px; height:46px; font-size:18px; }
        .image-counter { bottom:84px; right:18px; font-size:12px; padding:8px 16px; }
        .nav-btn { padding:10px 16px; font-size:13px; }
        .speed-btn { padding:7px 12px; }
    }
</style>
</head>
<body>
    <!-- Loading -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <h2>Loading Party Photos...</h2>
        <p style="opacity:.85">Getting the latest memories ready üì∏</p>
    </div>

    <div class="nav-buttons">
        <a class="nav-btn glass" href="/upload" title="Upload new photos">üì§ Upload</a>
    </div>

    <div class="title-overlay glass">
        <h1 class="main-title">üéâ SFC 30 Party</h1>
        <p class="subtitle">Share your moments and memories!</p>
    </div>

    <!-- Per-image view time buttons -->
    <div class="speed-controls">
        <button class="speed-btn glass" data-seconds="8">8s</button>
        <button class="speed-btn glass active" data-seconds="5">5s</button>
        <button class="speed-btn glass" data-seconds="3">3s</button>
        <button class="speed-btn glass" data-seconds="2">2s</button>
    </div>

    <!-- Carousel -->
    <div class="carousel-container">
        <div class="carousel-viewport glass" id="carousel-viewport">
            <div class="carousel-track" id="carousel-track">
                <!-- Two segments (base + clone) inserted dynamically -->
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="carousel-controls">
        <button class="control-btn glass" id="prev-btn" title="Previous (ArrowLeft)">‚èÆÔ∏è</button>
        <button class="control-btn glass" id="pause-btn" title="Pause / Play (Space)">‚è∏Ô∏è</button>
        <button class="control-btn glass" id="next-btn" title="Next (ArrowRight)">‚è≠Ô∏è</button>
        <button class="control-btn glass" id="direction-btn" title="Reverse Direction (R)">üîÑ</button>
        <button class="control-btn glass" id="refresh-btn" title="Refresh Images (F)">üîÉ</button>
    </div>

    <div class="image-counter glass" id="image-counter">0 photos</div>

    <!-- Popup -->
    <div class="image-popup" id="image-popup" aria-modal="true" role="dialog">
        <div class="popup-content">
            <img id="popup-image" alt="Enlarged photo" decoding="async" />
            <button id="close-popup" class="close-popup" aria-label="Close">&times;</button>
        </div>
    </div>

<script>
/*
  Improved carousel logic:
  - Single base segment of images + one cloned segment for seamless looping.
  - requestAnimationFrame drives smooth scrolling (no large duplicated DOM multiples).
  - Speed defined in seconds per image (width + gap).
  - Manual navigation adjusts logical offset & pauses auto-scroll briefly.
  - New images fetched every minute; only new ones appended (no full rebuild unless needed).
*/

let imageUrls = [];                  // Unique image URL list (base set)
let secondsPerImage = 5;             // Default view time per image
let gap = 20;                        // Gap (matches CSS .carousel-track gap)
let itemWidth = 300;                 // Base width (matches CSS .carousel-item flex-basis)
let isPaused = false;
let isReversed = false;
let autoResumeTimer = null;
let animationId = null;
let offsetPx = 0;                    // Current translation offset
let lastTs = 0;
let speedPxPerSec = calcSpeed();     // Computed pixels/second
let baseSegmentWidth = 0;            // Width of a single segment
let fetching = false;
let lastBuildCount = 0;

const track = document.getElementById('carousel-track');
const loadingOverlay = document.getElementById('loading-overlay');
const counterEl = document.getElementById('image-counter');
const pauseBtn = document.getElementById('pause-btn');
const directionBtn = document.getElementById('direction-btn');
const popup = document.getElementById('image-popup');
const popupImg = document.getElementById('popup-image');

function calcSpeed() {
    return (itemWidth + gap) / secondsPerImage;
}

function showLoading() { loadingOverlay.style.display = 'flex'; }
function hideLoading() { loadingOverlay.style.display = 'none'; }

function updateCounter() {
    counterEl.textContent = `${imageUrls.length} photo${imageUrls.length === 1 ? '' : 's'}`;
}

function createToast(msg) {
    const t = document.createElement('div');
    t.className = 'toast glass';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3200);
}

function altFromUrl(url) {
    try {
        const name = url.split('/').pop().split('?')[0];
        return name.replace(/[-_]/g,' ').replace(/\.[^.]+$/,'');
    } catch { return 'Party image'; }
}

/* Build (or rebuild) the track: base + clone */
function buildTrack(appendOnly=false) {
    // If we are only appending a few new images, append to base segment & then rebuild clone.
    if (appendOnly && track.children.length === 2) {
        const baseSeg = track.children[0];
        const cloneSeg = track.children[1];
        // Add new image elements for just the delta
        const existing = baseSeg.querySelectorAll('.carousel-item').length;
        for (let i = existing; i < imageUrls.length; i++) {
            baseSeg.appendChild(createItem(imageUrls[i], i));
        }
        // Rebuild clone
        cloneSeg.innerHTML = '';
        for (let i = 0; i < imageUrls.length; i++) {
            cloneSeg.appendChild(createItem(imageUrls[i], i, true));
        }
    } else {
        track.innerHTML = '';
        const baseSeg = document.createElement('div');
        baseSeg.className = 'carousel-segment';
        imageUrls.forEach((u, i) => baseSeg.appendChild(createItem(u, i)));
        const cloneSeg = document.createElement('div');
        cloneSeg.className = 'carousel-segment';
        imageUrls.forEach((u, i) => cloneSeg.appendChild(createItem(u, i, true)));
        track.appendChild(baseSeg);
        track.appendChild(cloneSeg);
        offsetPx = 0;
    }

    // Measure width (sum itemWidth + gap * (n-1))
    baseSegmentWidth = imageUrls.length * (itemWidth + gap);
    lastBuildCount = imageUrls.length;
}

function createItem(url, index, clone=false) {
    const wrap = document.createElement('button');
    wrap.type = 'button';
    wrap.className = 'carousel-item glass';
    wrap.setAttribute('aria-label', `Open image ${index+1}`);
    wrap.addEventListener('click', () => openPopup(url));
    const img = document.createElement('img');
    img.src = url;
    img.alt = altFromUrl(url);
    img.loading = 'lazy';
    img.decoding = 'async';
    img.onerror = () => {
        wrap.style.background = 'rgba(255,0,0,.35)';
        wrap.innerHTML = "<span style='padding:10px;font-size:12px'>Failed</span>";
    };
    wrap.appendChild(img);
    return wrap;
}

/* Animation loop */
function animate(ts) {
    if (!lastTs) lastTs = ts;
    const dt = (ts - lastTs) / 1000;
    lastTs = ts;

    if (!isPaused && baseSegmentWidth > 0) {
        const dirFactor = isReversed ? 1 : -1;
        offsetPx += dirFactor * speedPxPerSec * dt;
        // Normalize offset within one segment width
        if (offsetPx <= -baseSegmentWidth) offsetPx += baseSegmentWidth;
        else if (offsetPx >= 0) offsetPx -= baseSegmentWidth;
        track.style.transform = `translateX(${offsetPx}px)`;
    }
    animationId = requestAnimationFrame(animate);
}

/* Manual navigation (shift exactly one image width) */
function shiftByImages(n) {
    pauseAutoTemp();
    offsetPx += n * (itemWidth + gap);
    // Normalize similarly to animation loop
    while (offsetPx <= -baseSegmentWidth) offsetPx += baseSegmentWidth;
    while (offsetPx >= 0) offsetPx -= baseSegmentWidth;
    track.style.transform = `translateX(${offsetPx}px)`;
}

function setSecondsPerImage(newSeconds, evt=null) {
    secondsPerImage = newSeconds;
    speedPxPerSec = calcSpeed();
    document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
    if (evt && evt.currentTarget) evt.currentTarget.classList.add('active');
    else {
        document.querySelectorAll('.speed-btn').forEach(b => {
            if (Number(b.dataset.seconds) === secondsPerImage) b.classList.add('active');
        });
    }
}

/* Popup */
function openPopup(url) {
    popupImg.src = url;
    popup.classList.add('open');
    pauseAutoTemp(true);
}
function closePopup() {
    popup.classList.remove('open');
    resumeAfterTemp();
}

/* Pause logic */
function togglePause() {
    isPaused = !isPaused;
    pauseBtn.textContent = isPaused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
    pauseBtn.title = isPaused ? 'Play (Space)' : 'Pause (Space)';
}
function toggleDirection() {
    isReversed = !isReversed;
    directionBtn.textContent = isReversed ? '‚Ü©Ô∏è' : 'üîÑ';
}

function pauseAutoTemp(fromPopup=false) {
    isPaused = true;
    pauseBtn.textContent = '‚ñ∂Ô∏è';
    if (!fromPopup) {
        if (autoResumeTimer) clearTimeout(autoResumeTimer);
        autoResumeTimer = setTimeout(() => {
            isPaused = false;
            pauseBtn.textContent = '‚è∏Ô∏è';
        }, 3000);
    }
}
function resumeAfterTemp() {
    isPaused = false;
    pauseBtn.textContent = '‚è∏Ô∏è';
}

/* Fetching images */
async function fetchImages(first=false) {
    if (fetching) return;
    fetching = true;
    try {
        const res = await fetch('/api/images', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        if (data.status === 'error') throw new Error(data.error || 'API error');
        const urls = (data.images || []).filter(Boolean);
        if (first) showLoading();
        if (urls.length === 0) {
            showEmpty();
            return;
        }
        const newOnes = urls.filter(u => !imageUrls.includes(u));
        if (newOnes.length > 0) {
            imageUrls = urls;  // Keep order from server
            buildTrack(lastBuildCount > 0); // append if already built
            updateCounter();
            if (lastBuildCount > 0) createToast(`üéâ ${newOnes.length} new photo${newOnes.length>1?'s':''} added`);
        }
        hideLoading();
    } catch (e) {
        console.error(e);
        if (first) showError();
    } finally {
        fetching = false;
    }
}

function showEmpty() {
    hideLoading();
    track.innerHTML = `<div style="width:100%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.2rem;">üì∏ No photos yet. <a href="/upload" style="margin-left:12px;color:#fff;text-decoration:underline;">Upload</a></div>`;
}
function showError() {
    hideLoading();
    track.innerHTML = `<div style="width:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;text-align:center;gap:12px;">
        <div style="font-size:1.3rem;">‚ùå Error loading photos</div>
        <button class="nav-btn glass" onclick="location.reload()">Retry</button>
    </div>`;
}

/* Event wiring */
document.querySelectorAll('.speed-btn').forEach(btn => {
    btn.addEventListener('click', e => setSecondsPerImage(Number(btn.dataset.seconds), e));
});

document.getElementById('prev-btn').addEventListener('click', () => shiftByImages(+1));
document.getElementById('next-btn').addEventListener('click', () => shiftByImages(-1));
pauseBtn.addEventListener('click', togglePause);
directionBtn.addEventListener('click', toggleDirection);
document.getElementById('refresh-btn').addEventListener('click', () => fetchImages(false));

document.addEventListener('keydown', e => {
    if (e.target.closest('input,textarea')) return;
    switch (e.key) {
        case ' ': e.preventDefault(); togglePause(); break;
        case 'ArrowLeft': shiftByImages(+1); break;
        case 'ArrowRight': shiftByImages(-1); break;
        case 'Escape': closePopup(); break;
        case 'r': case 'R': toggleDirection(); break;
        case 'f': case 'F': fetchImages(false); break;
        case '1': setSecondsPerImage(8); break;
        case '2': setSecondsPerImage(5); break;
        case '3': setSecondsPerImage(3); break;
        case '4': setSecondsPerImage(2); break;
    }
});

document.getElementById('close-popup').addEventListener('click', closePopup);
popup.addEventListener('click', e => { if (e.target === popup) closePopup(); });

/* Visibility (pause when hidden) */
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        isPaused = true;
    } else {
        isPaused = false;
        pauseBtn.textContent = '‚è∏Ô∏è';
    }
});

/* Resize debounced: recompute widths / speed */
let resizeTimer;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
        // Recalculate itemWidth (in case responsive breakpoint changed)
        const firstItem = document.querySelector('.carousel-item');
        if (firstItem) {
            itemWidth = firstItem.getBoundingClientRect().width; // includes padding
            speedPxPerSec = calcSpeed();
            baseSegmentWidth = imageUrls.length * (itemWidth + gap);
        }
    }, 180);
});

/* Init */
(async function init() {
    await fetchImages(true);
    updateCounter();
    hideLoading();
    buildTrack();
    speedPxPerSec = calcSpeed();
    if (animationId) cancelAnimationFrame(animationId);
    requestAnimationFrame(animate);
})();

/* Poll every 60s for new images */
setInterval(() => fetchImages(false), 60_000);
</script>
</body>
</html>
