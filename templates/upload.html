<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Upload Photo - SFC 30</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:Arial,system-ui,sans-serif;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  min-height:100vh;
  color:#fff;
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding:28px 16px 80px;
}
.upload-container{
  width:100%;
  max-width:560px;
  background:rgba(255,255,255,0.09);
  backdrop-filter:blur(14px);
  border:1px solid rgba(255,255,255,0.15);
  border-radius:28px;
  box-shadow:0 20px 40px -12px rgba(0,0,0,.45);
  padding:40px 34px 46px;
  display:flex;
  flex-direction:column;
  gap:26px;
}
.title{
  font-size:2.3rem;
  font-weight:700;
  line-height:1.05;
  margin:0 0 6px;
  background:linear-gradient(45deg,#6ef9d1,#a0f3ff,#ffeaa7);
  background-size:220% 220%;
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  animation:grad 6s linear infinite;
  text-align:center;
}
@keyframes grad{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}
.subtitle{font-size:1.05rem;text-align:center;color:rgba(255,255,255,.85);}
.flash-messages{display:flex;flex-direction:column;gap:6px;font-size:.85rem;}
.flash-message{padding:10px 14px;border-radius:12px;font-weight:600;}
.flash-error{background:rgba(255,107,107,.18);border:1px solid rgba(255,107,107,.5);color:#ffc0c0;}
.flash-success{background:rgba(78,205,196,.2);border:1px solid rgba(78,205,196,.55);color:#d4fffa;}

.section{display:flex;flex-direction:column;gap:18px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);padding:22px 22px 26px;border-radius:22px;}
.section h2{font-size:1rem;letter-spacing:.5px;font-weight:600;margin:0;display:flex;gap:6px;align-items:center;text-transform:uppercase;opacity:.85;}

.camera-container{position:relative;display:flex;justify-content:center;}
#video{
  width:100%;max-width:420px;height:300px;border-radius:18px;
  object-fit:cover;
  background:rgba(0,0,0,.35);
  border:2px solid rgba(255,255,255,.25);
}
#canvas{display:none;}
.preview-container{text-align:center;display:none;}
.preview-image{max-width:100%;max-height:300px;border-radius:18px;border:2px solid rgba(255,255,255,.25);}

.button-group{display:flex;flex-wrap:wrap;justify-content:center;gap:14px;}
.btn{padding:12px 24px;border:none;border-radius:30px;font-size:.95rem;font-weight:600;cursor:pointer;transition:.25s;letter-spacing:.5px;display:inline-flex;align-items:center;gap:6px;}
.btn-primary{background:linear-gradient(45deg,#667eea,#764ba2);color:#fff;box-shadow:0 6px 18px -6px rgba(118,75,162,.55);}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 26px -6px rgba(118,75,162,.65);}
.btn-secondary{background:linear-gradient(45deg,#ff6b6b,#ff944d);color:#fff;box-shadow:0 6px 18px -6px rgba(255,107,107,.55);}
.btn-secondary:hover{transform:translateY(-2px);box-shadow:0 10px 26px -6px rgba(255,107,107,.65);}
.btn-success{background:linear-gradient(45deg,#4ecdc4,#229b8c);color:#fff;box-shadow:0 6px 18px -6px rgba(78,205,196,.55);}
.btn-success:hover{transform:translateY(-2px);box-shadow:0 10px 26px -6px rgba(78,205,196,.65);}

.upload-options{display:flex;flex-wrap:wrap;justify-content:center;gap:14px;}
.file-input{display:none;}
.file-label{cursor:pointer;padding:12px 20px;border-radius:30px;font-weight:600;font-size:.9rem;letter-spacing:.4px;background:linear-gradient(45deg,#96ceb4,#ffeaa7);color:#242424;box-shadow:0 6px 20px -8px rgba(150,206,180,.6);transition:.25s;min-width:170px;text-align:center;}
.file-label.camera-label{background:linear-gradient(45deg,#ff6b6b,#ffa726);color:#fff;}
.file-label:hover{transform:translateY(-2px);box-shadow:0 10px 28px -10px rgba(150,206,180,.75);}
.file-label.camera-label:hover{box-shadow:0 10px 28px -10px rgba(255,107,107,.75);}

#uploadForm{text-align:center;display:none;}
#uploadForm .btn-success{min-width:210px;}

.bulk-area{border:2px dashed rgba(255,255,255,.35);border-radius:22px;padding:30px 20px;text-align:center;background:rgba(255,255,255,.06);transition:.25s;position:relative;}
.bulk-area.dragover{background:rgba(255,255,255,.12);border-color:#fff;}
.bulk-area input{display:none;}
.bulk-area label{display:inline-block;padding:12px 24px;margin-top:10px;border-radius:28px;background:linear-gradient(45deg,#6ef9d1,#a0f3ff);color:#103b3a;font-weight:600;cursor:pointer;letter-spacing:.4px;font-size:.9rem;transition:.25s;}
.bulk-area label:hover{transform:translateY(-2px);box-shadow:0 10px 26px -8px rgba(110,249,209,.6);}

.file-list{margin-top:18px;text-align:left;max-height:180px;overflow:auto;font-size:.75rem;line-height:1.3;}
.file-list ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;}
.file-list li{padding:10px 12px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2);border-radius:12px;}
.progress-wrap{margin-top:18px;}
.progress-bar-bg{width:100%;height:14px;border-radius:8px;background:rgba(255,255,255,.15);overflow:hidden;}
.progress-bar-fill{height:100%;width:0;background:linear-gradient(90deg,#4ecdc4,#229b8c);transition:width .25s;}
.bulk-actions{display:flex;justify-content:center;margin-top:16px;}
.bulk-actions .btn-success{min-width:230px;}

.back-link{text-align:center;display:inline-block;margin-top:-4px;color:rgba(255,255,255,.85);text-decoration:none;font-weight:500;font-size:.9rem;letter-spacing:.4px;}
.back-link:hover{color:#fff;text-decoration:underline;}

@media (max-width:560px){
  .upload-container{padding:30px 22px 40px;border-radius:26px;}
  .title{font-size:2rem;}
  #video,.preview-image{height:260px;}
  .file-label{min-width:140px;font-size:.8rem;padding:10px 16px;}
  .bulk-area{padding:26px 16px;}
  .upload-container{gap:22px;}
}
</style>
</head>
<body>
  <div class="upload-container">
    <div>
      <h1 class="title">Take a Photo</h1>
      <p class="subtitle">Share your moment at SFC 30!</p>
      {% with messages = get_flashed_messages() %}
      {% if messages %}
      <div class="flash-messages">
        {% for message in messages %}
          {% if "Error" in message or "Invalid" in message %}
            <div class="flash-message flash-error">{{ message }}</div>
          {% else %}
            <div class="flash-message flash-success">{{ message }}</div>
          {% endif %}
        {% endfor %}
      </div>
      {% endif %}
      {% endwith %}
    </div>

    <!-- Single photo / camera capture -->
    <div class="section" id="singleSection">
      <h2>üì∑ Capture or Select One</h2>
      <div class="camera-container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
      </div>
      <div class="preview-container" id="previewContainer">
        <img id="previewImage" class="preview-image" alt="Preview">
      </div>
      <div class="button-group">
        <button id="startCamera" class="btn btn-primary">Start Camera</button>
        <button id="captureBtn" class="btn btn-secondary" style="display:none;">Take Photo</button>
        <button id="retakeBtn" class="btn btn-primary" style="display:none;">Retake</button>
      </div>
      <div class="upload-options">
        <label for="galleryInput" class="file-label">üìÅ Choose from Gallery</label>
        <input type="file" id="galleryInput" accept="image/*" class="file-input">
        <label for="cameraInput" class="file-label camera-label">üì∏ Take Photo</label>
        <input type="file" id="cameraInput" accept="image/*" capture="environment" class="file-input">
      </div>
      <form id="uploadForm" method="POST" enctype="multipart/form-data" style="display:none;">
        <input type="file" id="hiddenFileInput" name="file" hidden>
        <button type="submit" class="btn btn-success">Upload Photo</button>
      </form>
    </div>

    <!-- Bulk upload -->
    <div class="section" id="bulkSection">
      <h2>üóÇ Bulk Upload</h2>
      <div class="bulk-area" id="dropArea">
        <p style="font-size:.9rem;line-height:1.4;">
          Drag & drop multiple images here<br>or
        </p>
        <label for="multiInput">Select Photos</label>
        <input type="file" id="multiInput" name="files[]" multiple accept="image/*">
        <div class="file-list" id="fileList" style="display:none;"></div>
        <div class="progress-wrap" id="progressWrap" style="display:none;">
          <div class="progress-bar-bg"><div class="progress-bar-fill" id="bulkProgress"></div></div>
        </div>
        <div class="bulk-actions" id="bulkActions" style="display:none;">
          <button id="bulkUploadBtn" class="btn btn-success" type="button">Upload Selected</button>
        </div>
      </div>
    </div>

    <a href="{{ url_for('main') }}" class="back-link">‚Üê Back to Slideshow</a>
  </div>

<script>
/* Camera + single file logic */
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const startCameraBtn=document.getElementById('startCamera');
const captureBtn=document.getElementById('captureBtn');
const retakeBtn=document.getElementById('retakeBtn');
const previewContainer=document.getElementById('previewContainer');
const previewImage=document.getElementById('previewImage');
const galleryInput=document.getElementById('galleryInput');
const cameraInput=document.getElementById('cameraInput');
const uploadForm=document.getElementById('uploadForm');
const hiddenFileInput=document.getElementById('hiddenFileInput');

let stream=null;

startCameraBtn.addEventListener('click',async ()=>{
  if(stream) return;
  try{
    const constraints={video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}}};
    stream=await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject=stream;
    startCameraBtn.style.display='none';
    captureBtn.style.display='inline-flex';
    previewContainer.style.display='none';
    video.style.display='block';
  }catch(err){
    console.error(err);
    alert('Could not access camera. Please check permissions or use file upload.');
  }
});

captureBtn.addEventListener('click',()=>{
  const ctx=canvas.getContext('2d');
  canvas.width=video.videoWidth || 1280;
  canvas.height=video.videoHeight || 720;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const finalize = blob =>{
    const url=URL.createObjectURL(blob);
    previewImage.src=url;
    previewContainer.style.display='block';
    video.style.display='none';
    captureBtn.style.display='none';
    retakeBtn.style.display='inline-flex';
    uploadForm.style.display='block';
    const file=new File([blob],'camera_photo.jpg',{type:'image/jpeg'});
    const dt=new DataTransfer();
    dt.items.add(file);
    hiddenFileInput.files=dt.files;
  };
  if(canvas.toBlob){
    canvas.toBlob(finalize,'image/jpeg',0.9);
  }else{
    const data=canvas.toDataURL('image/jpeg',0.9);
    const bstr=atob(data.split(',')[1]);const len=bstr.length;const u8=new Uint8Array(len);
    for(let i=0;i<len;i++)u8[i]=bstr.charCodeAt(i);
    finalize(new Blob([u8],{type:'image/jpeg'}));
  }
});

retakeBtn.addEventListener('click',()=>{
  previewContainer.style.display='none';
  video.style.display='block';
  captureBtn.style.display='inline-flex';
  retakeBtn.style.display='none';
  uploadForm.style.display='none';
});

function handleSingleFile(file){
  const reader=new FileReader();
  reader.onload=e=>{
    previewImage.src=e.target.result;
    previewContainer.style.display='block';
    video.style.display='none';
    if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
    startCameraBtn.style.display='none';
    captureBtn.style.display='none';
    retakeBtn.style.display='inline-flex';
    uploadForm.style.display='block';
    const dt=new DataTransfer();
    dt.items.add(file);
    hiddenFileInput.files=dt.files;
  };
  reader.readAsDataURL(file);
}
galleryInput.addEventListener('change',e=>{if(e.target.files[0]) handleSingleFile(e.target.files[0]);});
cameraInput.addEventListener('change',e=>{if(e.target.files[0]) handleSingleFile(e.target.files[0]);});
window.addEventListener('beforeunload',()=>{if(stream) stream.getTracks().forEach(t=>t.stop());});

/* Bulk upload */
const dropArea=document.getElementById('dropArea');
const multiInput=document.getElementById('multiInput');
const fileListEl=document.getElementById('fileList');
const progressWrap=document.getElementById('progressWrap');
const progressBar=document.getElementById('bulkProgress');
const bulkActions=document.getElementById('bulkActions');
const bulkUploadBtn=document.getElementById('bulkUploadBtn');

function showFiles(files){
  if(!files.length){fileListEl.style.display='none';bulkActions.style.display='none';return;}
  fileListEl.innerHTML='';
  const ul=document.createElement('ul');
  files.forEach(f=>{
    const li=document.createElement('li');
    const size=(f.size/1024/1024).toFixed(2);
    li.innerHTML='<strong>'+f.name+'</strong><br><small>'+size+' MB ‚Ä¢ '+(f.type||'')+'</small>';
    ul.appendChild(li);
  });
  fileListEl.appendChild(ul);
  fileListEl.style.display='block';
  bulkActions.style.display='flex';
}
multiInput.addEventListener('change',e=>showFiles([...e.target.files]));

['dragenter','dragover'].forEach(evt=>{
  dropArea.addEventListener(evt,e=>{
    e.preventDefault();e.stopPropagation();dropArea.classList.add('dragover');
  });
});
['dragleave','drop'].forEach(evt=>{
  dropArea.addEventListener(evt,e=>{
    e.preventDefault();e.stopPropagation();
    if(evt==='drop'){
      const files=[...e.dataTransfer.files].filter(f=>/^image\//.test(f.type));
      if(files.length){
        const dt=new DataTransfer();files.forEach(f=>dt.items.add(f));
        multiInput.files=dt.files;showFiles(files);
      }
    }
    dropArea.classList.remove('dragover');
  });
});

bulkUploadBtn.addEventListener('click',async ()=>{
  const files=[...multiInput.files];
  if(!files.length){alert('Select images first');return;}
  progressWrap.style.display='block';
  progressBar.style.width='0%';
  bulkUploadBtn.disabled=true;bulkUploadBtn.textContent='Uploading...';
  for(let i=0;i<files.length;i++){
    const formData=new FormData();
    formData.append('file',files[i]);
    try{ await fetch('/upload',{method:'POST',body:formData}); }catch(err){ console.error('Upload failed',files[i].name,err); }
    const pct=Math.round(((i+1)/files.length)*100);
    progressBar.style.width=pct+'%';
  }
  bulkUploadBtn.textContent='Done!';
  setTimeout(()=>{bulkUploadBtn.disabled=false;bulkUploadBtn.textContent='Upload Selected';},1800);
});

document.addEventListener('keydown',e=>{
  if(e.code==='Space' && document.activeElement.tagName==='BUTTON'){e.preventDefault();}
});
</script>
</body>
</html>
